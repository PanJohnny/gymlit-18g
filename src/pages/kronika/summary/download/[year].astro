---
import teachers from "../../../../../public/teachers.json";
import {quoteFix, getPhrases} from "../../../../utils";
const yearID = Astro.params.year;
if (!yearID)
    return Astro.redirect("/kronika");

const classYear: number = +yearID;

if (classYear < 0 || classYear > 8) {
    return new Response(undefined, {
        status: 400,
        statusMessage: "Year requested must be between 0 and 8"
    });
}

let csv = "Rok,ID Učitele,Učitel,Hláška\n";
let nl = true;

function insert(s:string) {
    if (!nl) {
        csv += ","
    } else
        nl = false;

    csv += '"' + quoteFix(s) + '"';
}

function newLine() {
    csv += "\n";
    nl = true;
}

const phrases = await getPhrases(classYear);

Object.keys(phrases).forEach((teacherID) => {
    phrases[teacherID].forEach((p) => {
        insert(classYear.toString());
        insert(teacherID);
        insert(teachers[teacherID]);
        insert(p);
        newLine();
    })
});

return new Response("\ufeffsep=,\n\ufeff" + csv, {
    headers: {
        "Content-Type": "text/csv; charset=utf-8",
        "Content-Disposition": "attachment",
        "filename": "gymlit18G-hlasky-" + classYear + ".csv"
    }
});
---